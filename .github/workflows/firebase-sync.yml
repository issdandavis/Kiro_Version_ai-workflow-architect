name: Firebase Sync

on:
  push:
    branches:
      - main
      - copilot/**
    paths:
      - 'docs/living-document.md'
      - 'docs/taxonomy.md'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-to-firebase:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Sync living document to Firebase
        env:
          FIREBASE_CONFIG: ${{ secrets.FIREBASE_CONFIG }}
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          echo "ðŸ”„ Syncing living-document.md to Firebase..."

          # Read the living document
          LIVING_DOC=$(cat docs/living-document.md)
          TAXONOMY=$(cat docs/taxonomy.md)

          # Create JSON payload
          cat > /tmp/sync-payload.json << EOF
          {
            "living_document": $(echo "$LIVING_DOC" | jq -Rs .),
            "taxonomy": $(echo "$TAXONOMY" | jq -Rs .),
            "last_updated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "source": "github-actions",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}"
          }
          EOF

          # Log the sync attempt
          # (actual Firebase sync requires credentials)
          echo "âœ… Prepared sync payload:"
          cat /tmp/sync-payload.json | jq .

          # TODO: Implement Firebase API call when credentials configured
          # Example:
          # curl -X POST \
          #   "https://firestore.googleapis.com/v1/projects/..." \
          #   -H "Authorization: Bearer $FIREBASE_TOKEN" \
          #   -H "Content-Type: application/json" \
          #   -d @/tmp/sync-payload.json

          echo "â„¹ï¸  Firebase credentials not configured."
          echo "â„¹ï¸  Configure secrets to enable sync."

      - name: Summary
        run: |
          echo "### ðŸ“Š Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Living Document**: Ready" >> $GITHUB_STEP_SUMMARY
          echo "- **Taxonomy**: Ready" >> $GITHUB_STEP_SUMMARY
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          echo "- **Timestamp**: ${TIMESTAMP}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ Configure Firebase secrets to enable" \
            >> $GITHUB_STEP_SUMMARY
          echo "full sync functionality." >> $GITHUB_STEP_SUMMARY
